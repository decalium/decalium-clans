--- a/net/minecraft/commands/arguments/selector/EntitySelector.java
+++ b/net/minecraft/commands/arguments/selector/EntitySelector.java
@@ -3,6 +3,7 @@
 import com.google.common.collect.Lists;
 import com.mojang.brigadier.exceptions.CommandSyntaxException;
 import java.util.Collections;
+import java.util.Iterator;
 import java.util.List;
 import java.util.UUID;
 import java.util.function.BiConsumer;
@@ -23,12 +24,14 @@
 import net.minecraft.world.phys.Vec3;
 
 public class EntitySelector {
+
     public static final int INFINITE = Integer.MAX_VALUE;
     private static final EntityTypeTest<Entity, ?> ANY_TYPE = new EntityTypeTest<Entity, Entity>() {
         public Entity tryCast(Entity obj) {
             return obj;
         }
 
+        @Override
         public Class<? extends Entity> getBaseClass() {
             return Entity.class;
         }
@@ -62,7 +65,7 @@
         this.currentEntity = senderOnly;
         this.playerName = playerName;
         this.entityUUID = uuid;
-        this.type = (EntityTypeTest<Entity, ?>)(type == null ? ANY_TYPE : type);
+        this.type = (EntityTypeTest) (type == null ? EntitySelector.ANY_TYPE : type);
         this.usesSelector = usesAt;
     }
 
@@ -86,139 +89,165 @@
         return this.usesSelector;
     }
 
-    private void checkPermissions(CommandSourceStack commandSourceStack) throws CommandSyntaxException {
-        if (this.usesSelector && !commandSourceStack.hasPermission(2)) {
+    private void checkPermissions(CommandSourceStack commandlistenerwrapper) throws CommandSyntaxException {
+        if (this.usesSelector && !commandlistenerwrapper.hasPermission(2, "minecraft.command.selector")) { // CraftBukkit
             throw EntityArgument.ERROR_SELECTORS_NOT_ALLOWED.create();
         }
     }
 
-    public Entity findSingleEntity(CommandSourceStack commandSourceStack) throws CommandSyntaxException {
-        this.checkPermissions(commandSourceStack);
-        List<? extends Entity> list = this.findEntities(commandSourceStack);
+    public Entity findSingleEntity(CommandSourceStack commandlistenerwrapper) throws CommandSyntaxException {
+        this.checkPermissions(commandlistenerwrapper);
+        List<? extends Entity> list = this.findEntities(commandlistenerwrapper);
+
         if (list.isEmpty()) {
             throw EntityArgument.NO_ENTITIES_FOUND.create();
         } else if (list.size() > 1) {
             throw EntityArgument.ERROR_NOT_SINGLE_ENTITY.create();
         } else {
-            return list.get(0);
+            return (Entity) list.get(0);
         }
     }
 
-    public List<? extends Entity> findEntities(CommandSourceStack commandSourceStack) throws CommandSyntaxException {
-        this.checkPermissions(commandSourceStack);
+    public List<? extends Entity> findEntities(CommandSourceStack commandlistenerwrapper) throws CommandSyntaxException {
+        this.checkPermissions(commandlistenerwrapper);
         if (!this.includesEntities) {
-            return this.findPlayers(commandSourceStack);
+            return this.findPlayers(commandlistenerwrapper);
         } else if (this.playerName != null) {
-            ServerPlayer serverPlayer = commandSourceStack.getServer().getPlayerList().getPlayerByName(this.playerName);
-            return (List<? extends Entity>)(serverPlayer == null ? Collections.emptyList() : Lists.newArrayList(serverPlayer));
+            ServerPlayer entityplayer = commandlistenerwrapper.getServer().getPlayerList().getPlayerByName(this.playerName);
+
+            return (List) (entityplayer == null ? Collections.emptyList() : Lists.newArrayList(new ServerPlayer[]{entityplayer}));
         } else if (this.entityUUID != null) {
-            for(ServerLevel serverLevel : commandSourceStack.getServer().getAllLevels()) {
-                Entity entity = serverLevel.getEntity(this.entityUUID);
-                if (entity != null) {
-                    return Lists.newArrayList(entity);
+            Iterator iterator = commandlistenerwrapper.getServer().getAllLevels().iterator();
+
+            Entity entity;
+
+            do {
+                if (!iterator.hasNext()) {
+                    return Collections.emptyList();
                 }
-            }
 
-            return Collections.emptyList();
+                ServerLevel worldserver = (ServerLevel) iterator.next();
+
+                entity = worldserver.getEntity(this.entityUUID);
+            } while (entity == null);
+
+            return Lists.newArrayList(new Entity[]{entity});
         } else {
-            Vec3 vec3 = this.position.apply(commandSourceStack.getPosition());
-            Predicate<Entity> predicate = this.getPredicate(vec3);
+            Vec3 vec3d = (Vec3) this.position.apply(commandlistenerwrapper.getPosition());
+            Predicate<Entity> predicate = this.getPredicate(vec3d);
+
             if (this.currentEntity) {
-                return (List<? extends Entity>)(commandSourceStack.getEntity() != null && predicate.test(commandSourceStack.getEntity()) ? Lists.newArrayList(commandSourceStack.getEntity()) : Collections.emptyList());
+                return (List) (commandlistenerwrapper.getEntity() != null && predicate.test(commandlistenerwrapper.getEntity()) ? Lists.newArrayList(new Entity[]{commandlistenerwrapper.getEntity()}) : Collections.emptyList());
             } else {
                 List<Entity> list = Lists.newArrayList();
+
                 if (this.isWorldLimited()) {
-                    this.addEntities(list, commandSourceStack.getLevel(), vec3, predicate);
+                    this.addEntities(list, commandlistenerwrapper.getLevel(), vec3d, predicate);
                 } else {
-                    for(ServerLevel serverLevel2 : commandSourceStack.getServer().getAllLevels()) {
-                        this.addEntities(list, serverLevel2, vec3, predicate);
+                    Iterator iterator1 = commandlistenerwrapper.getServer().getAllLevels().iterator();
+
+                    while (iterator1.hasNext()) {
+                        ServerLevel worldserver1 = (ServerLevel) iterator1.next();
+
+                        this.addEntities(list, worldserver1, vec3d, predicate);
                     }
                 }
 
-                return this.sortAndLimit(vec3, list);
+                return this.sortAndLimit(vec3d, (List) list);
             }
         }
     }
 
-    private void addEntities(List<Entity> list, ServerLevel serverLevel, Vec3 vec3, Predicate<Entity> predicate) {
+    private void addEntities(List<Entity> list, ServerLevel worldserver, Vec3 vec3d, Predicate<Entity> predicate) {
         if (this.aabb != null) {
-            list.addAll(serverLevel.getEntities(this.type, this.aabb.move(vec3), predicate));
+            list.addAll(worldserver.getEntities(this.type, this.aabb.move(vec3d), predicate));
         } else {
-            list.addAll(serverLevel.getEntities(this.type, predicate));
+            list.addAll(worldserver.getEntities(this.type, predicate));
         }
 
     }
 
-    public ServerPlayer findSinglePlayer(CommandSourceStack commandSourceStack) throws CommandSyntaxException {
-        this.checkPermissions(commandSourceStack);
-        List<ServerPlayer> list = this.findPlayers(commandSourceStack);
+    public ServerPlayer findSinglePlayer(CommandSourceStack commandlistenerwrapper) throws CommandSyntaxException {
+        this.checkPermissions(commandlistenerwrapper);
+        List<ServerPlayer> list = this.findPlayers(commandlistenerwrapper);
+
         if (list.size() != 1) {
             throw EntityArgument.NO_PLAYERS_FOUND.create();
         } else {
-            return list.get(0);
+            return (ServerPlayer) list.get(0);
         }
     }
 
-    public List<ServerPlayer> findPlayers(CommandSourceStack commandSourceStack) throws CommandSyntaxException {
-        this.checkPermissions(commandSourceStack);
+    public List<ServerPlayer> findPlayers(CommandSourceStack commandlistenerwrapper) throws CommandSyntaxException {
+        this.checkPermissions(commandlistenerwrapper);
+        ServerPlayer entityplayer;
+
         if (this.playerName != null) {
-            ServerPlayer serverPlayer = commandSourceStack.getServer().getPlayerList().getPlayerByName(this.playerName);
-            return (List<ServerPlayer>)(serverPlayer == null ? Collections.emptyList() : Lists.newArrayList(serverPlayer));
+            entityplayer = commandlistenerwrapper.getServer().getPlayerList().getPlayerByName(this.playerName);
+            return (List) (entityplayer == null ? Collections.emptyList() : Lists.newArrayList(new ServerPlayer[]{entityplayer}));
         } else if (this.entityUUID != null) {
-            ServerPlayer serverPlayer2 = commandSourceStack.getServer().getPlayerList().getPlayer(this.entityUUID);
-            return (List<ServerPlayer>)(serverPlayer2 == null ? Collections.emptyList() : Lists.newArrayList(serverPlayer2));
+            entityplayer = commandlistenerwrapper.getServer().getPlayerList().getPlayer(this.entityUUID);
+            return (List) (entityplayer == null ? Collections.emptyList() : Lists.newArrayList(new ServerPlayer[]{entityplayer}));
         } else {
-            Vec3 vec3 = this.position.apply(commandSourceStack.getPosition());
-            Predicate<Entity> predicate = this.getPredicate(vec3);
+            Vec3 vec3d = (Vec3) this.position.apply(commandlistenerwrapper.getPosition());
+            Predicate<Entity> predicate = this.getPredicate(vec3d);
+
             if (this.currentEntity) {
-                if (commandSourceStack.getEntity() instanceof ServerPlayer) {
-                    ServerPlayer serverPlayer3 = (ServerPlayer)commandSourceStack.getEntity();
-                    if (predicate.test(serverPlayer3)) {
-                        return Lists.newArrayList(serverPlayer3);
+                if (commandlistenerwrapper.getEntity() instanceof ServerPlayer) {
+                    ServerPlayer entityplayer1 = (ServerPlayer) commandlistenerwrapper.getEntity();
+
+                    if (predicate.test(entityplayer1)) {
+                        return Lists.newArrayList(new ServerPlayer[]{entityplayer1});
                     }
                 }
 
                 return Collections.emptyList();
             } else {
-                List<ServerPlayer> list;
+                Object object;
+
                 if (this.isWorldLimited()) {
-                    list = commandSourceStack.getLevel().getPlayers(predicate);
+                    object = commandlistenerwrapper.getLevel().getPlayers(predicate);
                 } else {
-                    list = Lists.newArrayList();
+                    object = Lists.newArrayList();
+                    Iterator iterator = commandlistenerwrapper.getServer().getPlayerList().getPlayers().iterator();
 
-                    for(ServerPlayer serverPlayer4 : commandSourceStack.getServer().getPlayerList().getPlayers()) {
-                        if (predicate.test(serverPlayer4)) {
-                            list.add(serverPlayer4);
+                    while (iterator.hasNext()) {
+                        ServerPlayer entityplayer2 = (ServerPlayer) iterator.next();
+
+                        if (predicate.test(entityplayer2)) {
+                            ((List) object).add(entityplayer2);
                         }
                     }
                 }
 
-                return this.sortAndLimit(vec3, list);
+                return this.sortAndLimit(vec3d, (List) object);
             }
         }
     }
 
-    private Predicate<Entity> getPredicate(Vec3 vec3) {
+    private Predicate<Entity> getPredicate(Vec3 vec3d) {
         Predicate<Entity> predicate = this.predicate;
+
         if (this.aabb != null) {
-            AABB aABB = this.aabb.move(vec3);
+            AABB axisalignedbb = this.aabb.move(vec3d);
+
             predicate = predicate.and((entity) -> {
-                return aABB.intersects(entity.getBoundingBox());
+                return axisalignedbb.intersects(entity.getBoundingBox());
             });
         }
 
         if (!this.range.isAny()) {
             predicate = predicate.and((entity) -> {
-                return this.range.matchesSqr(entity.distanceToSqr(vec3));
+                return this.range.matchesSqr(entity.distanceToSqr(vec3d));
             });
         }
 
         return predicate;
     }
 
-    private <T extends Entity> List<T> sortAndLimit(Vec3 vec3, List<T> list) {
+    private <T extends Entity> List<T> sortAndLimit(Vec3 vec3d, List<T> list) {
         if (list.size() > 1) {
-            this.order.accept(vec3, list);
+            this.order.accept(vec3d, list);
         }
 
         return list.subList(0, Math.min(this.maxResults, list.size()));
