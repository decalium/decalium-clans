--- a/net/minecraft/world/entity/decoration/ItemFrame.java
+++ b/net/minecraft/world/entity/decoration/ItemFrame.java
@@ -32,20 +32,22 @@
 import net.minecraft.world.level.saveddata.maps.MapItemSavedData;
 import net.minecraft.world.phys.AABB;
 import net.minecraft.world.phys.Vec3;
-import org.apache.commons.lang3.Validate;
+import org.bukkit.craftbukkit.libs.org.apache.commons.lang3.Validate;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
 public class ItemFrame extends HangingEntity {
+
     private static final Logger LOGGER = LogManager.getLogger();
     private static final EntityDataAccessor<ItemStack> DATA_ITEM = SynchedEntityData.defineId(ItemFrame.class, EntityDataSerializers.ITEM_STACK);
     private static final EntityDataAccessor<Integer> DATA_ROTATION = SynchedEntityData.defineId(ItemFrame.class, EntityDataSerializers.INT);
     public static final int NUM_ROTATIONS = 8;
-    private float dropChance = 1.0F;
-    private boolean fixed;
+    public float dropChance;
+    public boolean fixed;
 
     public ItemFrame(EntityType<? extends ItemFrame> type, Level world) {
         super(type, world);
+        this.dropChance = 1.0F;
     }
 
     public ItemFrame(Level world, BlockPos pos, Direction facing) {
@@ -54,26 +56,30 @@
 
     public ItemFrame(EntityType<? extends ItemFrame> type, Level world, BlockPos pos, Direction facing) {
         super(type, world, pos);
+        this.dropChance = 1.0F;
         this.setDirection(facing);
     }
 
+    @Override
     protected float getEyeHeight(Pose pose, EntityDimensions dimensions) {
         return 0.0F;
     }
 
+    @Override
     protected void defineSynchedData() {
-        this.getEntityData().define(DATA_ITEM, ItemStack.EMPTY);
-        this.getEntityData().define(DATA_ROTATION, 0);
+        this.getEntityData().define(ItemFrame.DATA_ITEM, ItemStack.EMPTY);
+        this.getEntityData().define(ItemFrame.DATA_ROTATION, 0);
     }
 
-    protected void setDirection(Direction facing) {
+    @Override
+    public void setDirection(Direction facing) {
         Validate.notNull(facing);
         this.direction = facing;
         if (facing.getAxis().isHorizontal()) {
             this.setXRot(0.0F);
-            this.setYRot((float)(this.direction.get2DDataValue() * 90));
+            this.setYRot((float) (this.direction.get2DDataValue() * 90));
         } else {
-            this.setXRot((float)(-90 * facing.getAxisDirection().getStep()));
+            this.setXRot((float) (-90 * facing.getAxisDirection().getStep()));
             this.setYRot(0.0F);
         }
 
@@ -82,46 +88,64 @@
         this.recalculateBoundingBox();
     }
 
+    @Override
     protected void recalculateBoundingBox() {
         if (this.direction != null) {
-            double d = 0.46875D;
-            double e = (double)this.pos.getX() + 0.5D - (double)this.direction.getStepX() * 0.46875D;
-            double f = (double)this.pos.getY() + 0.5D - (double)this.direction.getStepY() * 0.46875D;
-            double g = (double)this.pos.getZ() + 0.5D - (double)this.direction.getStepZ() * 0.46875D;
-            this.setPosRaw(e, f, g);
-            double h = (double)this.getWidth();
-            double i = (double)this.getHeight();
-            double j = (double)this.getWidth();
-            Direction.Axis axis = this.direction.getAxis();
-            switch(axis) {
-            case X:
-                h = 1.0D;
-                break;
-            case Y:
-                i = 1.0D;
-                break;
-            case Z:
-                j = 1.0D;
+            // CraftBukkit start code moved in to calculateBoundingBox
+            this.setBoundingBox(ItemFrame.calculateBoundingBox(this, this.pos, this.direction, this.getWidth(), this.getHeight()));
+            // CraftBukkit end
+        }
+    }
+
+    // CraftBukkit start - break out BB calc into own method
+    public static AABB calculateBoundingBox(@Nullable Entity entity, BlockPos blockPosition, Direction direction, int width, int height) {
+        {
+            double d0 = 0.46875D;
+            double d1 = (double) blockPosition.getX() + 0.5D - (double) direction.getStepX() * 0.46875D;
+            double d2 = (double) blockPosition.getY() + 0.5D - (double) direction.getStepY() * 0.46875D;
+            double d3 = (double) blockPosition.getZ() + 0.5D - (double) direction.getStepZ() * 0.46875D;
+
+            if (entity != null) {
+                entity.setPosRaw(d1, d2, d3);
+            }
+            double d4 = (double) width;
+            double d5 = (double) height;
+            double d6 = (double) width;
+            Direction.Axis enumdirection_enumaxis = direction.getAxis();
+
+            switch (enumdirection_enumaxis) {
+                case X:
+                    d4 = 1.0D;
+                    break;
+                case Y:
+                    d5 = 1.0D;
+                    break;
+                case Z:
+                    d6 = 1.0D;
             }
 
-            h = h / 32.0D;
-            i = i / 32.0D;
-            j = j / 32.0D;
-            this.setBoundingBox(new AABB(e - h, f - i, g - j, e + h, f + i, g + j));
+            d4 /= 32.0D;
+            d5 /= 32.0D;
+            d6 /= 32.0D;
+            return new AABB(d1 - d4, d2 - d5, d3 - d6, d1 + d4, d2 + d5, d3 + d6);
         }
     }
+    // CraftBukkit end
 
+    @Override
     public boolean survives() {
         if (this.fixed) {
             return true;
         } else if (!this.level.noCollision(this)) {
             return false;
         } else {
-            BlockState blockState = this.level.getBlockState(this.pos.relative(this.direction.getOpposite()));
-            return blockState.getMaterial().isSolid() || this.direction.getAxis().isHorizontal() && DiodeBlock.isDiode(blockState) ? this.level.getEntities(this, this.getBoundingBox(), HANGING_ENTITY).isEmpty() : false;
+            BlockState iblockdata = this.level.getBlockState(this.pos.relative(this.direction.getOpposite()));
+
+            return !iblockdata.getMaterial().isSolid() && (!this.direction.getAxis().isHorizontal() || !DiodeBlock.isDiode(iblockdata)) ? false : this.level.getEntities(this, this.getBoundingBox(), ItemFrame.HANGING_ENTITY).isEmpty();
         }
     }
 
+    @Override
     public void move(MoverType movementType, Vec3 movement) {
         if (!this.fixed) {
             super.move(movementType, movement);
@@ -129,6 +153,7 @@
 
     }
 
+    @Override
     public void push(double deltaX, double deltaY, double deltaZ) {
         if (!this.fixed) {
             super.push(deltaX, deltaY, deltaZ);
@@ -136,15 +161,18 @@
 
     }
 
+    @Override
     public float getPickRadius() {
         return 0.0F;
     }
 
+    @Override
     public void kill() {
         this.removeFramedMap(this.getItem());
         super.kill();
     }
 
+    @Override
     public boolean hurt(DamageSource source, float amount) {
         if (this.fixed) {
             return source != DamageSource.OUT_OF_WORLD && !source.isCreativePlayer() ? false : super.hurt(source, amount);
@@ -152,6 +180,11 @@
             return false;
         } else if (!source.isExplosion() && !this.getItem().isEmpty()) {
             if (!this.level.isClientSide) {
+                // CraftBukkit start - fire EntityDamageEvent
+                if (org.bukkit.craftbukkit.v1_17_R1.event.CraftEventFactory.handleNonLivingEntityDamageEvent(this, source, amount, false) || this.isRemoved()) {
+                    return true;
+                }
+                // CraftBukkit end
                 this.dropItem(source.getEntity(), false);
                 this.playSound(this.getRemoveItemSound(), 1.0F, 1.0F);
             }
@@ -166,20 +199,25 @@
         return SoundEvents.ITEM_FRAME_REMOVE_ITEM;
     }
 
+    @Override
     public int getWidth() {
         return 12;
     }
 
+    @Override
     public int getHeight() {
         return 12;
     }
 
+    @Override
     public boolean shouldRenderAtSqrDistance(double distance) {
-        double d = 16.0D;
-        d = d * 64.0D * getViewScale();
-        return distance < d * d;
+        double d1 = 16.0D;
+
+        d1 *= 64.0D * getViewScale();
+        return distance < d1 * d1;
     }
 
+    @Override
     public void dropItem(@Nullable Entity entity) {
         this.playSound(this.getBreakSound(), 1.0F, 1.0F);
         this.dropItem(entity, true);
@@ -189,6 +227,7 @@
         return SoundEvents.ITEM_FRAME_BREAK;
     }
 
+    @Override
     public void playPlacementSound() {
         this.playSound(this.getPlaceSound(), 1.0F, 1.0F);
     }
@@ -199,18 +238,20 @@
 
     private void dropItem(@Nullable Entity entity, boolean alwaysDrop) {
         if (!this.fixed) {
-            ItemStack itemStack = this.getItem();
+            ItemStack itemstack = this.getItem();
+
             this.setItem(ItemStack.EMPTY);
             if (!this.level.getGameRules().getBoolean(GameRules.RULE_DOENTITYDROPS)) {
                 if (entity == null) {
-                    this.removeFramedMap(itemStack);
+                    this.removeFramedMap(itemstack);
                 }
 
             } else {
                 if (entity instanceof Player) {
-                    Player player = (Player)entity;
-                    if (player.getAbilities().instabuild) {
-                        this.removeFramedMap(itemStack);
+                    Player entityhuman = (Player) entity;
+
+                    if (entityhuman.getAbilities().instabuild) {
+                        this.removeFramedMap(itemstack);
                         return;
                     }
                 }
@@ -219,11 +260,11 @@
                     this.spawnAtLocation(this.getFrameItemStack());
                 }
 
-                if (!itemStack.isEmpty()) {
-                    itemStack = itemStack.copy();
-                    this.removeFramedMap(itemStack);
+                if (!itemstack.isEmpty()) {
+                    itemstack = itemstack.copy();
+                    this.removeFramedMap(itemstack);
                     if (this.random.nextFloat() < this.dropChance) {
-                        this.spawnAtLocation(itemStack);
+                        this.spawnAtLocation(itemstack);
                     }
                 }
 
@@ -233,18 +274,19 @@
 
     private void removeFramedMap(ItemStack map) {
         if (map.is(Items.FILLED_MAP)) {
-            MapItemSavedData mapItemSavedData = MapItem.getSavedData(map, this.level);
-            if (mapItemSavedData != null) {
-                mapItemSavedData.removedFromFrame(this.pos, this.getId());
-                mapItemSavedData.setDirty(true);
+            MapItemSavedData worldmap = MapItem.getSavedData(map, this.level);
+
+            if (worldmap != null) {
+                worldmap.removedFromFrame(this.pos, this.getId());
+                worldmap.setDirty(true);
             }
         }
 
-        map.setEntityRepresentation((Entity)null);
+        map.setEntityRepresentation((Entity) null);
     }
 
     public ItemStack getItem() {
-        return this.getEntityData().get(DATA_ITEM);
+        return (ItemStack) this.getEntityData().get(ItemFrame.DATA_ITEM);
     }
 
     public void setItem(ItemStack stack) {
@@ -252,18 +294,24 @@
     }
 
     public void setItem(ItemStack value, boolean update) {
-        if (!value.isEmpty()) {
-            value = value.copy();
-            value.setCount(1);
-            value.setEntityRepresentation(this);
+        // CraftBukkit start
+        this.setItem(value, update, true);
+    }
+
+    public void setItem(ItemStack itemstack, boolean flag, boolean playSound) {
+        // CraftBukkit end
+        if (!itemstack.isEmpty()) {
+            itemstack = itemstack.copy();
+            itemstack.setCount(1);
+            itemstack.setEntityRepresentation((Entity) this);
         }
 
-        this.getEntityData().set(DATA_ITEM, value);
-        if (!value.isEmpty()) {
+        this.getEntityData().set(ItemFrame.DATA_ITEM, itemstack);
+        if (!itemstack.isEmpty() && flag && playSound) { // CraftBukkit // Paper - only play sound when update flag is set
             this.playSound(this.getAddItemSound(), 1.0F, 1.0F);
         }
 
-        if (update && this.pos != null) {
+        if (flag && this.pos != null) {
             this.level.updateNeighbourForOutputSignal(this.pos, Blocks.AIR);
         }
 
@@ -273,12 +321,15 @@
         return SoundEvents.ITEM_FRAME_ADD_ITEM;
     }
 
+    @Override
     public SlotAccess getSlot(int mappedIndex) {
         return mappedIndex == 0 ? new SlotAccess() {
+            @Override
             public ItemStack get() {
                 return ItemFrame.this.getItem();
             }
 
+            @Override
             public boolean set(ItemStack stack) {
                 ItemFrame.this.setItem(stack);
                 return true;
@@ -286,18 +337,20 @@
         } : super.getSlot(mappedIndex);
     }
 
+    @Override
     public void onSyncedDataUpdated(EntityDataAccessor<?> data) {
-        if (data.equals(DATA_ITEM)) {
-            ItemStack itemStack = this.getItem();
-            if (!itemStack.isEmpty() && itemStack.getFrame() != this) {
-                itemStack.setEntityRepresentation(this);
+        if (data.equals(ItemFrame.DATA_ITEM)) {
+            ItemStack itemstack = this.getItem();
+
+            if (!itemstack.isEmpty() && itemstack.getFrame() != this) {
+                itemstack.setEntityRepresentation((Entity) this);
             }
         }
 
     }
 
     public int getRotation() {
-        return this.getEntityData().get(DATA_ROTATION);
+        return (Integer) this.getEntityData().get(ItemFrame.DATA_ROTATION);
     }
 
     public void setRotation(int value) {
@@ -305,41 +358,46 @@
     }
 
     private void setRotation(int value, boolean updateComparators) {
-        this.getEntityData().set(DATA_ROTATION, value % 8);
+        this.getEntityData().set(ItemFrame.DATA_ROTATION, value % 8);
         if (updateComparators && this.pos != null) {
             this.level.updateNeighbourForOutputSignal(this.pos, Blocks.AIR);
         }
 
     }
 
+    @Override
     public void addAdditionalSaveData(CompoundTag nbt) {
         super.addAdditionalSaveData(nbt);
         if (!this.getItem().isEmpty()) {
             nbt.put("Item", this.getItem().save(new CompoundTag()));
-            nbt.putByte("ItemRotation", (byte)this.getRotation());
+            nbt.putByte("ItemRotation", (byte) this.getRotation());
             nbt.putFloat("ItemDropChance", this.dropChance);
         }
 
-        nbt.putByte("Facing", (byte)this.direction.get3DDataValue());
+        nbt.putByte("Facing", (byte) this.direction.get3DDataValue());
         nbt.putBoolean("Invisible", this.isInvisible());
         nbt.putBoolean("Fixed", this.fixed);
     }
 
+    @Override
     public void readAdditionalSaveData(CompoundTag nbt) {
         super.readAdditionalSaveData(nbt);
-        CompoundTag compoundTag = nbt.getCompound("Item");
-        if (compoundTag != null && !compoundTag.isEmpty()) {
-            ItemStack itemStack = ItemStack.of(compoundTag);
-            if (itemStack.isEmpty()) {
-                LOGGER.warn("Unable to load item from: {}", (Object)compoundTag);
+        CompoundTag nbttagcompound1 = nbt.getCompound("Item");
+
+        if (nbttagcompound1 != null && !nbttagcompound1.isEmpty()) {
+            ItemStack itemstack = ItemStack.of(nbttagcompound1);
+
+            if (itemstack.isEmpty()) {
+                ItemFrame.LOGGER.warn("Unable to load item from: {}", nbttagcompound1);
             }
 
-            ItemStack itemStack2 = this.getItem();
-            if (!itemStack2.isEmpty() && !ItemStack.matches(itemStack, itemStack2)) {
-                this.removeFramedMap(itemStack2);
+            ItemStack itemstack1 = this.getItem();
+
+            if (!itemstack1.isEmpty() && !ItemStack.matches(itemstack, itemstack1)) {
+                this.removeFramedMap(itemstack1);
             }
 
-            this.setItem(itemStack, false);
+            this.setItem(itemstack, false);
             this.setRotation(nbt.getByte("ItemRotation"), false);
             if (nbt.contains("ItemDropChance", 99)) {
                 this.dropChance = nbt.getFloat("ItemDropChance");
@@ -351,25 +409,28 @@
         this.fixed = nbt.getBoolean("Fixed");
     }
 
+    @Override
     public InteractionResult interact(Player player, InteractionHand hand) {
-        ItemStack itemStack = player.getItemInHand(hand);
-        boolean bl = !this.getItem().isEmpty();
-        boolean bl2 = !itemStack.isEmpty();
+        ItemStack itemstack = player.getItemInHand(hand);
+        boolean flag = !this.getItem().isEmpty();
+        boolean flag1 = !itemstack.isEmpty();
+
         if (this.fixed) {
             return InteractionResult.PASS;
         } else if (!this.level.isClientSide) {
-            if (!bl) {
-                if (bl2 && !this.isRemoved()) {
-                    if (itemStack.is(Items.FILLED_MAP)) {
-                        MapItemSavedData mapItemSavedData = MapItem.getSavedData(itemStack, this.level);
-                        if (mapItemSavedData != null && mapItemSavedData.isTrackedCountOverLimit(256)) {
+            if (!flag) {
+                if (flag1 && !this.isRemoved()) {
+                    if (itemstack.is(Items.FILLED_MAP)) {
+                        MapItemSavedData worldmap = MapItem.getSavedData(itemstack, this.level);
+
+                        if (worldmap != null && worldmap.isTrackedCountOverLimit(256)) {
                             return InteractionResult.FAIL;
                         }
                     }
 
-                    this.setItem(itemStack);
+                    this.setItem(itemstack);
                     if (!player.getAbilities().instabuild) {
-                        itemStack.shrink(1);
+                        itemstack.shrink(1);
                     }
                 }
             } else {
@@ -379,7 +440,7 @@
 
             return InteractionResult.CONSUME;
         } else {
-            return !bl && !bl2 ? InteractionResult.PASS : InteractionResult.SUCCESS;
+            return !flag && !flag1 ? InteractionResult.PASS : InteractionResult.SUCCESS;
         }
     }
 
@@ -391,18 +452,22 @@
         return this.getItem().isEmpty() ? 0 : this.getRotation() % 8 + 1;
     }
 
+    @Override
     public Packet<?> getAddEntityPacket() {
         return new ClientboundAddEntityPacket(this, this.getType(), this.direction.get3DDataValue(), this.getPos());
     }
 
+    @Override
     public void recreateFromPacket(ClientboundAddEntityPacket packet) {
         super.recreateFromPacket(packet);
         this.setDirection(Direction.from3DDataValue(packet.getData()));
     }
 
+    @Override
     public ItemStack getPickResult() {
-        ItemStack itemStack = this.getItem();
-        return itemStack.isEmpty() ? this.getFrameItemStack() : itemStack.copy();
+        ItemStack itemstack = this.getItem();
+
+        return itemstack.isEmpty() ? this.getFrameItemStack() : itemstack.copy();
     }
 
     protected ItemStack getFrameItemStack() {
