--- a/net/minecraft/world/inventory/MerchantResultSlot.java
+++ b/net/minecraft/world/inventory/MerchantResultSlot.java
@@ -47,13 +47,30 @@
 
     @Override
     public void onTake(Player player, ItemStack stack) {
-        this.checkTakeAchievements(stack);
+        // this.checkTakeAchievements(stack); // Paper - move to after event is called and not cancelled
         MerchantOffer merchantOffer = this.slots.getActiveOffer();
+        // Paper start
+        io.papermc.paper.event.player.PlayerPurchaseEvent event = null;
+        if (this.merchant instanceof net.minecraft.world.entity.npc.AbstractVillager && this.merchant.getTradingPlayer().getBukkitEntity() instanceof org.bukkit.entity.Player) {
+            event = new io.papermc.paper.event.player.PlayerTradeEvent((org.bukkit.entity.Player) this.merchant.getTradingPlayer().getBukkitEntity(), (org.bukkit.entity.AbstractVillager) ((net.minecraft.world.entity.npc.AbstractVillager) this.merchant).getBukkitEntity(), merchantOffer.asBukkit(), true, true);
+        } else if (this.merchant instanceof org.bukkit.craftbukkit.v1_18_R1.inventory.CraftMerchantCustom.MinecraftMerchant && this.merchant.getTradingPlayer().getBukkitEntity() instanceof org.bukkit.entity.Player) {
+            event = new io.papermc.paper.event.player.PlayerPurchaseEvent((org.bukkit.entity.Player) this.merchant.getTradingPlayer().getBukkitEntity(), merchantOffer.asBukkit(), false, true);
+        }
+        if (event != null) {
+            if (!event.callEvent()) {
+                stack.setCount(0);
+                event.getPlayer().updateInventory();
+                return;
+            }
+            merchantOffer = org.bukkit.craftbukkit.v1_18_R1.inventory.CraftMerchantRecipe.fromBukkit(event.getTrade()).toMinecraft();
+        }
+        this.checkTakeAchievements(stack);
+        // Paper end
         if (merchantOffer != null) {
             ItemStack itemStack = this.slots.getItem(0);
             ItemStack itemStack2 = this.slots.getItem(1);
             if (merchantOffer.take(itemStack, itemStack2) || merchantOffer.take(itemStack2, itemStack)) {
-                this.merchant.notifyTrade(merchantOffer);
+                this.merchant.processTrade(merchantOffer, event); // Paper
                 player.awardStat(Stats.TRADED_WITH_VILLAGER);
                 this.slots.setItem(0, itemStack);
                 this.slots.setItem(1, itemStack2);
